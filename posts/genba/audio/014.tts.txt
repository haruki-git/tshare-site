Excel ブイビーエー：エラー処理とデバッグの基本。

よくある実行時エラー（1004・91・9）。

代表的な実行時エラーと原因・対処を短くまとめます。

 
 
・1004はApplication ハイフン defined or object ハイフン defined errorであり、存在しないシートの参照、保護シートへの書き込み、誤ったRange指定などで発生しやすいです。
 
・91はオブジェクト変数またはWithブロック変数が設定されていない状態であり、Setのし忘れや取得に失敗してNothingになっていることが原因です。
 
・9はインデックスが有効範囲にない状態であり、Worksheets("名前")の誤字やWorksheets(5)が存在しないなどで発生します。
 
 対処の基本は、エラー行を特定して「何を参照しようとしたか」を確認することです。ブイビーイーのステップ実行（F8）で直前の変数状態を見て、イミディエイトやDebug.Printで値を出していくと再現条件が絞れます。

 最小マクロ： エラーになりやすい参照（シート名）をわざと含めた最小例です。

（コード例があります）

On Error Resume Next の使い方。

エラーが起きても次の行へ進める命令です。「失敗しても問題ない」処理（例：存在しないものを消そうとする、任意シートがあれば参照したい等）に限定して使います。

 ポイントは次の3つです。

 
 
・影響範囲を最小にして、必要な行だけにかけます。
 
・Err.Number をすぐ確認し、必要なら Err.Clear します。
 
・処理が終わったら必ず On Error GoTo 0 で通常状態に戻し、戻し忘れを避けます。
 

 例（存在すれば削除し、なければ何もしない）です。

（コード例があります）

On Error GoTo での基本形。

エラー発生時に指定ラベルへジャンプし、共通の後片付け（設定の復元）やログ出力を行う定番パターンです。構造は次の形にすると崩れにくいです。

 
 
・先頭で On Error GoTo ErrHandler を書きます。
 
・本体処理の後に、正常終了用として Exit Sub を置きます。
 
・ ErrHandler: で Err情報を取得してログ出力や復旧を行い、必要に応じて Resume スラッシュ Resume Next スラッシュ Exit Sub を使います。
 

 基本形（エラー情報を Debug.Print へ出し、後で必ず終了する例）です。

（コード例があります）

ブレークポイントとステップ実行（F8）。

ブイビーイーのコード行左の余白をクリックするとブレークポイントを置けます。実行するとその行の手前で停止し、F8で1行ずつ進められます。

 よく使う観察手段は以下です。

 
 
・マウスオーバーで変数値を確認できます。
 
・Locals（ローカル）ウィンドウでスコープ内変数を一覧表示できます。
 
・ウォッチ式で特定の式を監視できます。
 

 外部参照（Worksheets取得、Range指定、ファイル操作など）の直後や、ループに入る直前にブレークポイントを置くと、1004・91・9の原因となる「参照先が想定と違う」状況を早期に見つけられます。