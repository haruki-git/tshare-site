関数とプロシージャの使い分け。

SubプロシージャとFunctionプロシージャの違い。

今回できるようになることとして、SubとFunctionの違いを理解し目的に合わせて使い分けられるようになります。

 Subプロシージャは処理を実行して結果をセルに書き出したりMsgBoxで通知したりするために使います。

 Functionプロシージャは値を返すために設計され、ワークシートに直接書ける自作関数（ユーザー定義関数）になります。

 Subは戻り値を返さない点、Functionは戻り値が必須な点が大きな違いです。

 イベントハンドラ（例：SheetのChange）はSubになりますし、計算に使いたい処理はFunctionにします。

 最小マクロ：

（コード例があります）

 貼り付け場所：上のコードは標準モジュール（ブイビーイーで挿入→標準モジュール）に貼り付けます。

 標準モジュールはSubやFunctionを複数まとめておけるので再利用しやすくなります。

 実行方法：ブイビーイー（オルト プラス F11）で該当モジュールを開き、カーソルをSub内に置いてF5で実行するか、Excel側でフォームコントロールのボタンに割り当てて実行できます。

引数（ByVal、ByRef）と戻り値。

引数の渡し方はByVal（値渡し）とByRef（参照渡し）があります。ByValは中の値をコピーして関数やSubに渡すため、呼び出し元の変数は変更されません。ByRefは呼び出し元の変数を直接扱うため、処理内で値を変えると呼び出し元にも反映されます（既定はByRefです）。

 戻り値はFunctionで1つ返すのが基本です。必要なら配列やVariantで複数値を返す方法も使えます。副作用（呼び出し元が書き変わる）を避けたい場合はByValを明示すると読みやすくなります。

 よくあるミスとして、引数を意図せずByRefにしてしまい、呼び出し元の値が書き換わることがあります。原因はByRefが既定な点です。直し方はByValを明示するか、処理で新しい変数にコピーしてから操作する方法があります。

 確認方法として、上の最小マクロを実行するとA1 スラッシュ B1に値が入り、MsgBoxで結果が確認できます。Functionの戻り値が期待通りか、セルやMsgBoxで検証してください。

WorksheetFunction.○○でワークシート関数を呼び出す。

ワークシートで使える関数はブイビーエーからWorksheetFunction経由で呼べます。SumやVLookup、Matchなどをブイビーエーで使うときに便利です。たとえば WorksheetFunction.Sum(Range("A1:A10")) で合計を取得できます。

 ただしWorksheetFunctionはエラーが発生するとランタイムエラーになるため、エラー制御（On Error Resume Nextなど）やApplication.WorksheetFunctionの使い分けを考えます。Application.WorksheetFunctionはエラー時の挙動が若干異なるケースがあるため、戻り値のチェックやエラーハンドリングを組むと堅牢になります。

 使い分けの基準として、RangeとCellsの使い分けは「可読性と可変インデックス」が基準になります。固定範囲ならRange("A1:B2")、ループで行列を扱うならCells(row, col)が便利です。ValueとValue2はValue2の方が日付や通貨の扱いで高速または精度差が出るケースがあるため、特に気にしなければValue2を使うことが多いです。また、ワークシート関数をブイビーエー内部で計算したいだけならWorksheetFunctionを使い、セルに式を書いてユーザーが結果を参照するならFunction（UDF）を作ると役割が分かりやすくなります。

（コード例があります）

自作関数をセルから使う方法。

自作関数（UDF）はPublic Functionで作ると、ワークシートのセルに =MyFunc(A1,B1) のように書いて使えます。

 関数は標準モジュールに置くとExcel側から見えるようになります。UDF内でセルを書き換える操作は推奨されないため、計算だけ行って値を返す設計にします。

 最小限の例として文字列結合や数値計算を返す関数を作ると理解しやすいです。セルに直接入力して使う場合は、保存形式をマクロ有効ブック（.xlsm）にしておく必要があります。

（コード例があります）

 この関数をセルに =ConcatWithDash(A1,B1) と書くと結合結果が返ります。保存形式が.xlsmでないとUDFは含まれないため、保存時にファイル形式を確認してください。