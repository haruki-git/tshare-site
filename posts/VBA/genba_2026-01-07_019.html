<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>実践プロジェクト：データ集計システム（Excel VBA）</title>
  <link rel="stylesheet" href="/assets/styles.css?v=1767406624605">
</head>
<body>
  <main class="container">
    <article class="card">
      <header>
        <h1>実践プロジェクト：データ集計システム（Excel VBA）</h1>
        <nav><a href="/posts/VBA/">VBA記事一覧</a></nav>
        <p class="meta">投稿日：2026-01-07</p>
      </header>

      <section class="card" style="margin-top:12px;">
        <h2 style="margin:0 0 8px 0;">音声</h2>
        <audio controls preload="none" src="/posts/genba/audio/019.mp3"></audio>
        <p class="meta" style="margin-top:8px; opacity:0.85;">※ AI音声で読み上げます</p>
      </section>

      <section id="sec-toc">
        <h2>目次</h2>
        <ol>
  <li><a href="#sec-1">プロジェクトの要件（複数ファイルからデータ収集）</a></li>
  <li><a href="#sec-2">フォルダ内の全Excelファイルを開く処理</a></li>
  <li><a href="#sec-3">データの統合と集計ロジック</a></li>
  <li><a href="#sec-4">集計結果のレポート作成</a></li>
  <li><a href="#sec-5">注意（ここだけ）</a></li>
</ol>
      </section>

      <section id="sec-1">
  <h3>プロジェクトの要件（複数ファイルからデータ収集）</h3>
  <p>今回できるようになることとして、複数のExcelファイルから指定列を集めて1つの集計表にまとめるVBAを作成できるようになります。</p>
<p>想定要件は次のとおりです。</p>
<ul>
  <li>フォルダ内に同様のレイアウト（ヘッダーが同じ）を持つxlsx/xlsmが複数ある前提です。</li>
  <li>各ファイルの「Data」シートからA〜C列を集めてマスターに統合し、集計（合計・件数）して別シートに出力する想定です。</li>
  <li>マクロは.xlsmで保存し、マクロ有効化をして、貼り付け場所は標準モジュールにする想定です。</li>
</ul>
<p>最小マクロ：下はファイル名を列挙するだけの最短例で、動作イメージ確認に使えます。</p>
<pre><code class="language-vb">' 最小マクロ：フォルダ内ファイル名を一覧（例）
Sub ListFiles()
    Dim f As String, r As Long
    Dim folder As String: folder = "C:\Data\"
    Sheets("Master").Cells.Clear
    r = 1
    f = Dir(folder &amp; "*.xls*")
    Do While f &lt;&gt; ""
        Sheets("Master").Cells(r, 1).Value = f
        r = r + 1
        f = Dir()
    Loop
    MsgBox "完了: " &amp; r - 1 &amp; " 件"
End Sub
</code></pre>
</section>

<section id="sec-2">
  <h3>フォルダ内の全Excelファイルを開く処理</h3>
  <p>フォルダ走査とファイルオープンはDir関数とWorkbooks.Openを組み合わせるのが基本です。</p>
<p>処理では画面更新を切り、読み取り専用で開いて必要範囲をコピーし、閉じる流れにします。</p>
<p>大きなファイルがあるときはApplication.CalculationをxlCalculationManualにしておくと高速化できます。</p>
<p>下は実装例で、エラーはログ用の配列に貯めて最後にまとめて表示します。</p>
<p>実行方法はVBEの実行（F5）か、クイックアクセスツールバーやフォームコントロールのボタンに割り当てる方法です。</p>
<p>ファイルは必ずマクロ有効形式で保存してください。</p>

<pre><code>Option Explicit
Sub CollectAllFiles()
    Dim folder As String, f As String
    Dim wbSrc As Workbook, wsSrc As Worksheet, wsDst As Worksheet
    Dim dstRow As Long, lastRow As Long
    Dim errList As Collection: Set errList = New Collection

    folder = "C:\Data\" ' フォルダは実行前に変更
    Set wsDst = ThisWorkbook.Sheets("Master")
    wsDst.Cells.Clear
    dstRow = 1

    Application.ScreenUpdating = False
    f = Dir(folder & "*.xls*")
    Do While f &lt;&gt; ""
        On Error GoTo OpenErr
        Set wbSrc = Workbooks.Open(folder & f, ReadOnly:=True)
        Set wsSrc = wbSrc.Worksheets("Data")
        lastRow = wsSrc.Cells(wsSrc.Rows.Count, "A").End(xlUp).Row
        wsSrc.Range("A2:C" &amp; lastRow).Copy wsDst.Cells(dstRow, 1)
        dstRow = dstRow + lastRow - 1
        wbSrc.Close SaveChanges:=False
        On Error GoTo 0
        f = Dir()
        ContinueLoop:
    Loop
    Application.ScreenUpdating = True
    MsgBox "ファイル収集完了"
    Exit Sub

OpenErr:
    errList.Add f
    On Error GoTo 0
    If Not wbSrc Is Nothing Then wbSrc.Close SaveChanges:=False
    f = Dir()
    Resume ContinueLoop
End Sub</code></pre>
</section>

<section id="sec-3">
  <h3>データの統合と集計ロジック</h3>
  <p>統合した生データは、ヘッダー行を一度だけ残して下へ追記するスタイルが扱いやすいです。</p>

<p>集計はピボットテーブルを作成するか、VBAで辞書（Scripting.Dictionary）を使ってグループ集計する方法があります。ピボットは少ないコードで柔軟ですが、VBA集計は処理中に細かい条件判定が入るときに便利です。</p>

<p>確認方法は、Masterシートの行数と、MsgBoxやImmediateウィンドウの出力で件数を確かめることです。予想と異なる場合は、ヘッダーが重複していないかを要チェックです。</p>

<p>使い分けの基準として、RangeとCellsは可読性と動的参照の違いで選びます。Range("A1")は固定参照に向き、Cells(r, c)はループに向きます。ValueとValue2は日付や通貨の扱いで微差があるため、通常はValue2を高速性重視で使い、日付精度が必要なときはValueを検討します。</p>
</section>

<section id="sec-4">
  <h3>集計結果のレポート作成</h3>
  <p>集計結果は専用の「Report」シートに出すと見やすくなります。</p>
<p>ピボットテーブルを使う場合は、データテーブルをテーブル化（ListObject）してからPivotCacheを作成すると安定します。</p>
<p>書式は数式や条件付き書式で整え、最終的にはPDFで出力することも多いです。</p>
<p>よくあるミスとして、ヘッダーのスペル違いで集計対象が欠けることが最も多いです。直し方は、元データのヘッダーを正規化（Trim/大文字小文字統一）してから処理する方法です。</p>
</section>

<section id="sec-5">
  <h3>注意（ここだけ）</h3>
  <ul>
  <li>破壊的な操作（削除・上書き・権限変更）をする前に、対象と影響範囲を確認して、必要ならバックアップを取ってから進めてください。</li>
</ul>
</section>

      
    </article>
  </main>
</body>
</html>