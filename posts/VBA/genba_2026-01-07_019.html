<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>実践プロジェクト：データ集計システム（Excel VBA）</title>
  <link rel="stylesheet" href="/assets/styles.css?v=1767406624605">
</head>
<body>
  <main class="container">
    <article class="card">
      <header>
        <h1>実践プロジェクト：データ集計システム（Excel VBA）</h1>
        <nav><a href="/posts/VBA/">VBA記事一覧</a></nav>
        <p class="meta">投稿日：2026-01-07</p>
      </header>

      <section class="card" style="margin-top:12px;">
        <h2 style="margin:0 0 8px 0;">音声</h2>
        <audio controls preload="none" src="/posts/genba/audio/019.mp3"></audio>
        <p class="meta" style="margin-top:8px; opacity:0.85;">※ AI音声で読み上げます</p>
      </section>

      <section id="sec-toc">
        <h2>目次</h2>
        <ol>
  <li><a href="#sec-1">プロジェクトの要件（複数ファイルからデータ収集）</a></li>
  <li><a href="#sec-2">フォルダ内の全Excelファイルを開く処理</a></li>
  <li><a href="#sec-3">データの統合と集計ロジック</a></li>
  <li><a href="#sec-4">集計結果のレポート作成</a></li>
  <li><a href="#sec-5">エラー処理の実装（ファイルが開けない場合など）</a></li>
  <li><a href="#sec-6">注意（ここだけ）</a></li>
  <li><a href="#sec-7">要約</a></li>
</ol>
      </section>

      <section id="sec-1">
  <h3>プロジェクトの要件（複数ファイルからデータ収集）</h3>
  <p>目的は、複数のExcel（同一フォーマット）から自動でデータを収集し、商品別・担当別などで合計を出すことです。</p>
<p>前提として、全ファイルで列見出し（日付／担当／商品／数量／売上など）が一致している必要があります。</p>
<p>マクロは集計用ブック（.xlsm）に置き、元ファイルは読み取り専用で扱います。</p>
<p>標準モジュールへコードを置くのが扱いやすく、実行権限（マクロ有効化）を必須とします。</p>
</section>

<section id="sec-2">
  <h3>フォルダ内の全Excelファイルを開く処理</h3>
  <p>フォルダの列挙はDirが簡単で高速です。サブフォルダの再帰処理や属性の詳細取得が必要な場合はFileSystemObjectを使う方法が適しています。</p>
<p>処理中は<code>Application.ScreenUpdating = False</code>と<code>Application.EnableEvents = False</code>を設定すると高速化しやすいです。</p>
<p>テンポラリ（~$）や隠しファイルはスキップしておくと安定しやすいです。</p>
<p>Excelファイルは読み取り専用（<code>ReadOnly:=True</code>）で開くと、意図しない上書きを避けやすいです。</p>
<p>大量ファイルを扱う場合は、処理前にファイル一覧を作っておくと、中断時の再開や復旧が行いやすいです。</p>
</section>

<section id="sec-3">
  <h3>データの統合と集計ロジック</h3>
  <p>流れは「取り込み→辞書で集計→出力」です。</p>
<p>各ファイルの必要行を集計シートへ追記し、Scripting.Dictionaryでキー（商品名など）ごとに数値を累積すると高速で簡潔です。</p>
<p>列は固定列番号で参照（Cells(row, col)）し、値取得はValue/Value2を用途で使い分けます。</p>
<p>処理後に辞書のキー順で集計シートに出力し、AutoFitなどで体裁を調整します。</p>
<p>失敗ファイルは別配列やErrorsシートに記録して後で確認します。</p>
</section>

<section id="sec-4">
  <h3>集計結果のレポート作成</h3>
  <p>出力は見やすさを優先し、ヘッダ書式や数値書式（#,##0）、桁区切り、ソート（順位付け）を行います。</p>
<p>運用面では集計結果を別ブック（例：YYYYMMDD_集計.xlsx）として保存し、マクロが不要な場合は.xlsxで出力します。</p>
<p>頻繁に使う場合はボタン割当やクイックアクセス登録で実行性を高めます。</p>
<p>最後に合計チェック（=SUM(B2:Bn)等）とMsgBoxで件数確認を行います。</p>
</section>

<section id="sec-5">
  <h3>エラー処理の実装（ファイルが開けない場合など）</h3>
  <p>Workbooks.Open直後にエラー検出の仕組みを入れ、開けないファイルはログ化してスキップします。</p>
<p>実装例として、ファイル単位では On Error Resume Next で Err.Number を確認し、問題があればErrorsシートへ日時・ファイル名・Err.Number・説明を追記して Err.Clearします。</p>
<p>共通処理型では On Error GoTo のハンドラでログ化と後片付け（Close/Release）をまとめます。</p>
<p>ロックや破損がある場合は、ReadOnly指定にするか、手動対応のワークフローを用意します。</p>
</section>

<section id="sec-6">
  <h3>注意（ここだけ）</h3>
  <ul>
  <li>
    <p>集計列順や見出しが一致しないと誤集計になるため、事前にサンプルで列順を確認することです。</p>
    <p>マクロは必ずバックアップを取り、初回は少数ファイルでテスト実行することです。</p>
  </li>
</ul>
</section>

      <section id="sec-7">
  <h3>要約</h3>
  <ol>
  <li><p>同一フォーマットの複数ファイルから自動でデータを収集し、辞書でキーごとに合計する設計が効率的です。</p></li>
  <li><p>ファイル列挙は単純ならDirを使い、サブフォルダも含めるならFileSystemObjectを使うのが適しています。</p></li>
  <li><p>処理中は画面更新とイベントを止め、ReadOnlyで開いて保存ミスを防ぐ運用が要チェックです。</p></li>
  <li><p>集計結果は別ブックで保存し、書式・ソート・合計チェックを行うと品質を保ちやすいです。</p></li>
  <li><p>開けないファイルはログに残し、On Errorで個別または共通ハンドラにより安全にスキップ・記録するのが確実です。</p></li>
</ol>
</section>
    </article>
  </main>
</body>
</html>