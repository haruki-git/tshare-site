<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Excel VBAで学ぶ「データベース的な処理」</title>
  <link rel="stylesheet" href="/assets/styles.css?v=1767406624605">
</head>
<body>
  <main class="container">
    <article class="card">
      <header>
        <h1>Excel VBAで学ぶ「データベース的な処理」</h1>
        <nav><a href="/posts/VBA/">VBA記事一覧</a></nav>
        <p class="meta">投稿日：2026-01-07</p>
      </header>

      <section class="card" style="margin-top:12px;">
        <h2 style="margin:0 0 8px 0;">音声</h2>
        <audio controls preload="none" src="/posts/genba/audio/017.mp3"></audio>
        <p class="meta" style="margin-top:8px; opacity:0.85;">※ AI音声で読み上げます</p>
      </section>

      <section id="sec-toc">
        <h2>目次</h2>
        <ol>
  <li><a href="#sec-1">Findメソッドでデータを検索する</a></li>
  <li><a href="#sec-2">FindNext、FindPreviousで連続検索</a></li>
  <li><a href="#sec-3">Dictionaryオブジェクトの活用（重複除去、カウント）</a></li>
  <li><a href="#sec-4">ユニークなリストの作成方法</a></li>
  <li><a href="#sec-5">クロス集計とピボットテーブルの自動化</a></li>
  <li><a href="#sec-6">注意（ここだけ）</a></li>
  <li><a href="#sec-7">要約</a></li>
</ol>
      </section>

      <section id="sec-1">
  <h3>Findメソッドでデータを検索する</h3>
  <p>Range.Findを使うと、指定範囲で最初の一致を効率的に取得できます。</p>
<p>主要引数はWhat、LookIn、LookAt（完全一致・部分一致）、SearchOrder（xlByRows・xlByColumns）、Afterです。</p>
<p>Afterは見落としを招きやすいため、一般的には検索対象範囲の最後のセルを指定しておくか、取得後のAddressを使ってループ制御します。</p>
<p>実務では列全体指定やCurrentRegionを使い、必要に応じてValueまたはValue2を選びます。</p>
<pre><code>Sub FindSample()
  Dim f As Range, key As String
  key = "検索語": If key = "" Then Exit Sub
  Set f = Worksheets("Sheet1").Range("A:A").Find(What:=key, LookIn:=xlValues, LookAt:=xlWhole)
  If Not f Is Nothing Then f.Interior.Color = vbYellow
End Sub</code></pre>
</section>

<section id="sec-2">
  <h3>FindNext、FindPreviousで連続検索</h3>
  <p>Findで最初のセルを取得したら、FindNextまたはFindPreviousで次を辿り、最初のAddressに戻った時点で終了するパターンが基本です。</p>
<p>ループでは必ずNothingチェックとfirstAddrの比較を行い、無限ループを避けられるようにします。</p>
<p>途中で処理（色付けや集計）を行えば、表中の全一致をまとめて扱えます。</p>

<pre><code class="language-vb">' 概要コード
Set f = ws.Columns("B").Find("対象", LookIn:=xlValues, LookAt:=xlPart)
If Not f Is Nothing Then
  firstAddr = f.Address
  Do
    f.Interior.Color = RGB(255,230,150)
    Set f = ws.Columns("B").FindNext(f)
    If f Is Nothing Then Exit Do
  Loop While f.Address &lt;&gt; firstAddr
End If</code></pre>
</section>

<section id="sec-3">
  <h3>Dictionaryオブジェクトの活用（重複除去、カウント）</h3>
  <p>Scripting.Dictionaryはキーの存在チェックがO(1)に近く、重複除去や出現回数カウントに適します。</p>
<p>参照設定は不要で、CreateObject("Scripting.Dictionary")で使えます。</p>
<p>ループで値をTrimして空白を除き、存在すれば値をインクリメントし、なければ追加するだけで頻度テーブルが作れます。</p>
<p>大規模データや繰り返し検索より高速です。</p>

<pre><code class="language-vb">Set dict = CreateObject("Scripting.Dictionary")
For Each r In ws.Range("C2", ws.Cells(Rows.Count, "C").End(xlUp))
  v = Trim(r.Value)
  If v &lt;&gt; "" Then If dict.Exists(v) Then dict(v) = dict(v) + 1 Else dict.Add v, 1
Next
</code></pre>
</section>

<section id="sec-4">
  <h3>ユニークなリストの作成方法</h3>
  <p>ユニーク抽出は主に二通りあります。1) Dictionaryでキーを集める方法は、プログラム内で加工・並べ替え・カウントを続けやすいです。2) <code>Range.AdvancedFilter(Action:=xlFilterCopy, Unique:=True)</code> でシート上に簡単に出力する方法は、ユーザーに見せる用途に便利です。用途に応じて使い分けます。</p>

<pre><code class="language-vb">' AdvancedFilter例
ws.Range("D1:D" &amp; ws.Cells(Rows.Count, "D").End(xlUp).Row).AdvancedFilter _
  Action:=xlFilterCopy, CopyToRange:=out.Range("A1"), Unique:=True
</code></pre>
</section>

<section id="sec-5">
  <h3>クロス集計とピボットテーブルの自動化</h3>
  <p>ピボットはPivotCache→PivotTableの順で作成します。データをテーブル（ListObject）にしておくと範囲管理が楽で、SourceDataにListObject.Rangeを渡すだけで済みます。</p>
<p>コードから行フィールドや列フィールド、データフィールドを設定し、RefreshTableで更新します。定期レポートの自動化やフィルタ、集計関数の制御に有効です。</p>

<pre><code>Set pc = ThisWorkbook.PivotCaches.Create(xlDatabase, wsData.Range("A1").CurrentRegion)
Set pt = pc.CreatePivotTable(wsOut.Range("A3"), "MyPivot")
With pt
  .PivotFields("カテゴリ").Orientation = xlRowField
  .PivotFields("月").Orientation = xlColumnField
  .AddDataField .PivotFields("金額"), "合計金額", xlSum
End With</code></pre>
</section>

<section id="sec-6">
  <h3>注意（ここだけ）</h3>
  <ul>
  <li>マクロを保存する場合はブックを「Excelマクロ有効ブック（.xlsm）」で保存してください。参照の追加や実行権限にも要チェックです。</li>
</ul>
</section>

      <section id="sec-7">
  <h3>要約</h3>
  <ul>
  <li>Findは引数を適切に指定し、Afterの扱いを要チェックして最初の一致を取得します。</li>
  <li>FindNext/FindPreviousは最初のAddressを保存し、Nothingチェックで全件処理を終えます。</li>
  <li>Dictionaryは重複除去とカウントが高速で大規模集計に向き、CreateObjectで利用可能です。</li>
  <li>ユニーク抽出はAdvancedFilterが手軽で、Dictionaryは後続処理に強みがあります。</li>
  <li>ピボットはPivotCache→PivotTableの流れで自動生成し、ListObjectと組合せると運用が楽です。</li>
</ul>
</section>
    </article>
  </main>
</body>
</html>